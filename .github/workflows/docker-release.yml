name: Docker Release Build

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.2.3)'
        required: true
        type: string

permissions:
  contents: write
  packages: write

env:
  PRODUCTION_CRYPTO: ON
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true"

jobs:
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      version_name: ${{ steps.version.outputs.version_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          VERSION_NAME="${VERSION#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Validate version format
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-.*)?$ ]]; then
            echo "Error: Invalid version format: $VERSION"
            echo "Expected: v1.2.3 or v1.2.3-beta"
            exit 1
          fi

  build-all-variants:
    name: Build All Variants
    runs-on: ubuntu-latest
    needs: prepare
    strategy:
      matrix:
        variant:
          - prodGmsWebsiteRelease
          - prodFossWebsiteRelease
          - prodFossStoreRelease
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.version }}

      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          df -h

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-release-${{ matrix.variant }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-release-${{ matrix.variant }}-
            ${{ runner.os }}-buildx-release-

      - name: Configure signing keystore
        if: ${{ secrets.SECRET_KEYSTORE != '' }}
        run: |
          echo "${{ secrets.SECRET_KEYSTORE }}" | base64 -d > keystore.jks
          echo "CI_KEYSTORE_PATH=./keystore.jks" >> $GITHUB_ENV
          echo "CI_KEYSTORE_PASSWORD=${{ secrets.SECRET_KEYSTORE_PASSWORD }}" >> $GITHUB_ENV
          echo "CI_KEYSTORE_ALIAS=${{ secrets.SECRET_KEYSTORE_ALIAS }}" >> $GITHUB_ENV

      - name: Set variant configuration
        run: |
          VARIANT="${{ matrix.variant }}"
          if [[ "$VARIANT" == *"Gms"* ]]; then
            echo "CI_BUILD_VARIANTS=prodGms" >> $GITHUB_ENV
            FLAVOR="GMS"
          else
            echo "CI_BUILD_VARIANTS=prodFoss" >> $GITHUB_ENV
            FLAVOR="FOSS"
          fi

          if [[ "$VARIANT" == *"Store"* ]]; then
            TYPE="Store"
          else
            TYPE="Website"
          fi

          echo "BUILD_FLAVOR=$FLAVOR" >> $GITHUB_ENV
          echo "BUILD_TYPE=$TYPE" >> $GITHUB_ENV

      - name: Build release APK
        run: |
          chmod +x build.sh
          ./build.sh release --production
        env:
          PRODUCTION_CRYPTO: ON
          CI_BUILD_VARIANTS: ${{ env.CI_BUILD_VARIANTS }}
          CI_KEYSTORE_PATH: ${{ env.CI_KEYSTORE_PATH }}
          CI_KEYSTORE_PASSWORD: ${{ env.CI_KEYSTORE_PASSWORD }}
          CI_KEYSTORE_ALIAS: ${{ env.CI_KEYSTORE_ALIAS }}

      - name: Clean up keystore
        if: always()
        run: rm -f keystore.jks

      - name: Rename APKs with version
        run: |
          VERSION="${{ needs.prepare.outputs.version_name }}"
          FLAVOR="${{ env.BUILD_FLAVOR }}"

          cd app/build/outputs/apk
          for apk in $(find . -name "*.apk"); do
            DIR=$(dirname "$apk")
            FILENAME=$(basename "$apk")
            SIGNED_STATUS="unsigned"
            if [[ -n "${{ secrets.SECRET_KEYSTORE }}" ]]; then
              SIGNED_STATUS="signed"
            fi
            NEW_NAME="EMMA-${VERSION}-${FLAVOR}-${SIGNED_STATUS}.apk"
            mv "$apk" "$DIR/$NEW_NAME"
            echo "Renamed: $apk -> $NEW_NAME"
          done

      - name: Generate checksums
        run: |
          cd app/build/outputs/apk
          for apk in $(find . -name "*.apk"); do
            sha256sum "$apk" > "$apk.sha256"
            cat "$apk.sha256"
          done

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: emma-${{ matrix.variant }}-${{ needs.prepare.outputs.version }}
          path: |
            app/build/outputs/apk/**/*.apk
            app/build/outputs/apk/**/*.sha256
            app/build/outputs/bundle/**/*.aab
          retention-days: 90

  build-server:
    name: Build Translation Server
    runs-on: ubuntu-latest
    needs: prepare

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.version }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build server image
        run: |
          chmod +x build.sh
          docker compose build python-server

      - name: Export server image
        run: |
          docker save emma-python-server:latest | gzip > emma-server-${{ needs.prepare.outputs.version }}.tar.gz

      - name: Generate server checksum
        run: |
          sha256sum emma-server-${{ needs.prepare.outputs.version }}.tar.gz > emma-server-${{ needs.prepare.outputs.version }}.tar.gz.sha256

      - name: Upload server image
        uses: actions/upload-artifact@v4
        with:
          name: emma-server-${{ needs.prepare.outputs.version }}
          path: |
            emma-server-*.tar.gz
            emma-server-*.sha256
          retention-days: 90

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [prepare, build-all-variants, build-server]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.version }}

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: Organize release files
        run: |
          mkdir -p release-files
          find release-artifacts -name "*.apk" -exec cp {} release-files/ \;
          find release-artifacts -name "*.sha256" -exec cp {} release-files/ \;
          find release-artifacts -name "*.aab" -exec cp {} release-files/ \;
          find release-artifacts -name "*.tar.gz" -exec cp {} release-files/ \;
          ls -lh release-files/

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"

          cat > release-notes.md << EOF
          # EMMA $VERSION Release

          ## ðŸš€ What's New

          Secure messaging with post-quantum cryptography and real-time translation.

          ### Features
          - âœ… Post-quantum encryption (ML-KEM-1024, ML-DSA-87)
          - âœ… Real-time Danish-English translation
          - âœ… Offline translation support
          - âœ… EL2 hypervisor detection
          - âœ… Adaptive security countermeasures

          ### Build Variants

          - **EMMA-GMS**: Production build with Google services
          - **EMMA-FOSS**: Fully open source build

          ### Checksums

          \`\`\`
          $(cat release-files/*.sha256)
          \`\`\`

          ### Translation Server

          Docker image for the Python translation server is included.

          \`\`\`bash
          # Extract and load server image
          gunzip emma-server-$VERSION.tar.gz
          docker load < emma-server-$VERSION.tar
          docker run -p 5353:5353 emma-python-server
          \`\`\`

          ### Installation

          1. Download the appropriate APK for your device
          2. Verify the checksum
          3. Install: \`adb install EMMA-*.apk\`

          ### Documentation

          - [Building from Source](https://github.com/${{ github.repository }}/blob/$VERSION/BUILDING.md)
          - [Docker Build Guide](https://github.com/${{ github.repository }}/blob/$VERSION/DOCKER_BUILD.md)
          - [Production Build Guide](https://github.com/${{ github.repository }}/blob/$VERSION/BUILD_GUIDE.md)

          ---

          **Full Changelog**: https://github.com/${{ github.repository }}/compare/...${VERSION}
          EOF

          cat release-notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.prepare.outputs.version }}
          name: EMMA ${{ needs.prepare.outputs.version }}
          body_path: release-notes.md
          draft: false
          prerelease: ${{ contains(needs.prepare.outputs.version, '-') }}
          files: release-files/*
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update release summary
        run: |
          echo "## ðŸŽ‰ Release ${{ needs.prepare.outputs.version }} Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -lh release-files/ >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Release URL" >> $GITHUB_STEP_SUMMARY
          echo "https://github.com/${{ github.repository }}/releases/tag/${{ needs.prepare.outputs.version }}" >> $GITHUB_STEP_SUMMARY
